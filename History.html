<script type="module">
  const correctPassword = "123";
  const enteredPassword = prompt("Enter password to view history:");

  if (enteredPassword !== correctPassword) {
    alert("Access denied.");
    window.location.href = "index.html";
  } else {
    (async () => {
      try {
        console.log("Password correct, loading Firebase modules...");
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js");
        const { getDatabase, ref, get, remove } = await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js");

        const firebaseConfig = {
          apiKey: "AIzaSyBoI9vQo5h3AJQUopsMb-oYEIbfYq81fSI",
          authDomain: "outcardchecklist.firebaseapp.com",
          projectId: "outcardchecklist",
          storageBucket: "outcardchecklist.appspot.com",
          messagingSenderId: "896455842388",
          appId: "1:896455842388:web:78a3c22808ad5a772a6bc1",
          measurementId: "G-ZT882MFNZP",
          databaseURL: "https://outcardchecklist-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const historyRef = ref(db, "completionHistory");
        const container = document.getElementById("history-container");

        console.log("Fetching history data...");
        const snapshot = await get(historyRef);

        if (!snapshot.exists()) {
          container.innerHTML = "<p>No history found.</p>";
          console.log("No history found.");
          return;
        }

        const data = snapshot.val();
        const entries = Object.values(data);

        console.log("Found entries:", entries.length);
        container.innerHTML = ""; // Clear container before adding

        entries.forEach(entry => {
          const div = document.createElement("div");
          div.className = "entry";
          div.innerHTML = `
            <strong>Out Card:</strong> ${entry.outCard} <br>
            <strong>Completed By:</strong> ${entry.completedBy} <br>
            <strong>Completed At:</strong> ${entry.completedAt} <br>
            <strong>Closing MOD:</strong> ${entry.closingMOD || "N/A"}
          `;
          container.appendChild(div);
        });

        // Setup clear history button listener AFTER password check and data loaded
        document.getElementById("clear-history").addEventListener("click", () => {
          if (confirm("Are you sure you want to clear all history?")) {
            remove(historyRef)
              .then(() => {
                container.innerHTML = "<p>History cleared.</p>";
                console.log("History cleared.");
              })
              .catch(error => {
                alert("Failed to clear history.");
                console.error("Clear error:", error);
              });
          }
        });

      } catch (error) {
        console.error("Error loading data:", error);
        alert("Failed to load history data. See console for details.");
      }
    })();
  }
</script>
